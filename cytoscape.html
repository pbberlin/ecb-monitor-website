<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ZEW-like Color Demo (Pico)</title>

    <!-- Pico CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css" />

    <!-- ZEW theme overrides -->
    <link rel="stylesheet" href="pico-zew-2.css" />
    <link rel="stylesheet" href="pico-zew-1.css" />

      <link rel="stylesheet" href="./css/main-fonts.css" />

    <style>
        body {
            background-color: #efefef;
        }
    </style>


</head>

<body>
    <header class="topbar">
        <div class="container">
            <p>header</p>
        </div>
    </header>

    <main class="container">

        <div id="cy" style="width:100%;height:700px;"></div>

        <button id="saveJsonBtn">Save JSON</button>

        <footer>
            footer
        </footer>

    </main>
</body>

</html>




<style>
    #cy {
        width: 90%;
        height: 600px;
        display: block;
        background-color: #efefef;
        border-radius: 0.2rem;
        /* border: 2px solid gray; */
    }
</style>
<script type="module">

    import cytoscape from 'cytoscape';


    import fcose from 'cytoscape-fcose';
    cytoscape.use(fcose);


    // https://github.com/mwri/cytoscape-dom-node
    // https://github.com/cytoscape/cytoscape.js-qtip
    // https://github.com/cytoscape/cytoscape.js-pdf-export
    // cytoscape.use( require('dom-node') );



    // grab Pico/ZEW variables if available; fall back to sampled hexes
    function getCssVar(name, fallback) {
        const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        return v || fallback;
    }


    const zew = {
        primary: getCssVar('--primary', '#C8D400'),      // lime
        primaryFocus: getCssVar('--primary-focus', '#C8D400'),      // lime
        primaryHover: getCssVar('--primary-hover', '#BABB2A'),
        cardBg: getCssVar('--card-background-color', '#D5ECF0'), // aqua
        border: getCssVar('--border-color', '#BDD0D3'),
        darkCard: getCssVar('--zew-grey-3', '#444042'),
        darkBorder: getCssVar('--zew-grey-1', '#56555B')
    };



    // use dark-ish nodes with lime accents (works in both light/dark pages)
    const cy = cytoscape({
        container: document.getElementById('cy'),
        style: [
            // node:child — nodes that have a parent.
            // node:leaf — nodes with no children (regular end nodes)
            {
                selector: 'node',
                style: {
                    'shape': 'round-rectangle',
                    'background-color': zew.primaryHover,
                    'border-width': 2,
                    'border-color': zew.primaryFocus,


                    'padding': '14px',

                    'color': '#eee',
                    'color': '#eaeacc',
                    'font-size': 12,



                    'text-wrap': 'wrap',
                    'text-valign': 'center',

                    'label': 'data(label)',
                }
            },
            {
                selector: 'node:child',
                style: {
                    'text-valign': 'center',
                    'font-size': 11,
                    // 'color':            'red',
                }
            },
            // selector: 'node:leaf'  // deprecated
            {

                selector: 'node:parent',
                style: {
                    'background-opacity': 1,
                    'background-color': zew.cardBg,
                    'border-width': 2,
                    'border-color': zew.border,

                    'color': zew.darkBorder,
                    'padding': '0',
                    'padding-bottom': '4px',
                    'padding-top': '24px',  // applies to all others :-(
                    'padding-top': '12px',  // applies to all others :-(


                    'text-valign': 'top',
                    'text-halign': 'center',
                    'text-margin-x': '2px',
                    'text-margin-y': ' -4px',  // outside above - avoiding huge padding inside

                    'font-size': 16
                }
            },

            // https://js.cytoscape.org/#style/labels
            {
                selector: 'edge',
                style: {
                    'width': 2,
                    'line-color': zew.primary,                 // lime accent
                    'target-arrow-shape': 'triangle',
                    'target-arrow-color': zew.primary,
                    // 'curve-style': 'bezier',
                    'curve-style': 'round-taxi',
                    'color': '#9aa4b2',
                    'font-size': 7,



                    'text-valign': 'bottom',
                    'text-valign': 'top',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    // 'text-margin-y':  '18px',
                    'text-margin-x': '-4px',     // h-align without arrow


                    'text-wrap': 'wrap',
                    'text-max-width ': '200px',
                    'line-height': 1.2,
                    'line-height': 1.0,


                    'label': 'data(label)',
                }
            },
        ],
        elements: {
            nodes: [], edges: []
        },
        layout: {
            name: 'grid',
            rows: 1
        },
        // data - versus elements
        data: {},
    });






    const elements = {
        nodes: [
            {
                data: {
                    id: 'st101',
                    label: 'Search\nGoogle',
                    description: "bla",
                    'source-label': "source label",         // no effect
                    'target-label': "target label",
                }
            },
            { data: { id: 'st102', label: 'Download\nURLs' } },
            { data: { id: 'st103', label: 'Correct\nf-type' } },
            { data: { id: 'st104', label: 'all pages\nby key-\n words' } },

            // Compound containers (PowerPoint grouping boxes)
            // Compound nodes are an addition to the traditional graph model. 
            // A compound node contains a number of child nodes, like a HTML DOM element containing child elements.
            // API treats compound nodes just like regular nodes
            //    just its position and dimensions are inferred / read only
            { data: { id: 'parent2', label: 'Researcher\ninput' } },          // compount node - parent
            { data: { id: 'st201', label: 'com-\npany\nCSV', parent: 'parent2' } },
            { data: { id: 'st202', label: 'search\nterms', parent: 'parent2' } },


        ],
        edges: [
            { data: { id: 'edg1', source: 'st101', target: 'st102', label: '900 comp.\n4 terms\n\n2 langs\n10 results' } },
            { data: { id: 'edg2', source: 'st102', target: 'st103', label: 'captcha\n403 block\n\nbroken URL\ndoubles' } },
            { data: { id: 'edg3', source: 'st103', target: 'st104', label: 'broken\nPDF\n \nunrelated\nPDF' } },
            { data: { id: 'edg4', source: 'st201', target: 'st101', label: 'differential' } },
            { data: { id: 'edg5', source: 'st202', target: 'st101', label: 'via\npbu' } },
        ]
    };


    cy.add(elements);



    const ele1 = cy.getElementById('st101');
    ele1.data("company", "bosch")
    ele1.data("description", "Search URLs <br>Download")
    ele1.data("search-term", "cbcr")
    console.log(`data ${ele1.data("company")}`)

    if (false) {
        ele1.show()
        ele1.hide()
    }


    const layout = cy.layout({

        name: 'grid',
        rows: 3,
        columns: 3,


        name: 'fcose',
        quality: 'proof',
        animate: false,
        // randomize:  true,
        incremental: true,



        // Fixed positions for some anchors (optional)
        fixedNodeConstraint: [
            // { nodeId: 'st101', position: { x: 100, y: 120 } }
        ],

        // Align rows/columns like a slide grid (optional)
        alignmentConstraint: {
            horizontal: [['st101', 'st102', 'st103', 'st104']],
            vertical: [['st201', 'st202']]
        },

        // Relative placement (optional)
        relativePlacementConstraint: [
            { left: 'st101', right: 'st102' },
            { left: 'st102', right: 'st103' },
            { top: 'st201', bottom: 'st202' }
        ]
    });







    function addGroupingBox(parentId, label, childIds) {
        cy.batch(() => {
            const parent = cy.getElementById(parentId);
            if (parent.empty()) {
                cy.add({ data: { id: parentId, label } });
                console.log(`  parent added -  id ${parentId} label ${label}`);
            } else {
                console.log(`  parent exists - id ${parentId} label ${label}`);
            }

            for (let i = 0; i < childIds.length; i++) {
                const cid = childIds[i];
                const child = cy.getElementById(cid);
                if (child.empty()) {
                    console.log(`  MISSING child  "${cid}" -  cannot reparent`);
                } else {
                    console.log(`  reparent child "${cid}" -> parent "${parentId}"`);
                    child.move({ parent: parentId });
                }
            }
        });

        // Helpful to confirm you’re looking at the right place:
        // cy.fit(cy.getElementById(parentId), 40);

        // cy.animate({ fit: { eles: cy.getElementById(parentId), padding: 180 }, duration: 800 });

    }
    addGroupingBox('parent1', 'Google API', ['st101', 'st102']);
    // addGroupingBox('parent1', 'My Group 2', [       'st102', 'st103']);
    // addGroupingBox('parent1', 'My Group outer', ['parent1','parent2']);



    layout.run();


    // === Step-by-step reveal (added) ===
    // Hide all nodes and edges, then reveal items one-by-one with Space or arrow right



    // we cannot just use ele.show().hide()
    // we need as CSS class ".hidden"
    cy.style().selector('.hidden').style({ 'opacity': 0, 'events': 'no' }).update();

    function hideAll() {
        cy.batch(() => {
            const all = cy.$('node, edge');
            for (let iIndex = 0; iIndex < all.length; iIndex += 1) {
                const ele = all[iIndex];
                ele.addClass('hidden');
            }
        });
    }

    // hideAllForReveal();

    const revealOrder = ['parent1', 'st101', 'st102', 'st103', 'st104', 'parent2', 'st201', 'st202'];

    let revealIndex = -1;

    function showEdgesOfNode(node) {
        const edges = node.connectedEdges();
        for (let jIndex = 0; jIndex < edges.length; jIndex += 1) {
            const e = edges[jIndex];
            const sVisible = !e.source().hasClass('hidden');
            const tVisible = !e.target().hasClass('hidden');
            if (sVisible && tVisible) {
                e.removeClass('hidden');
            }
        }
    }

    function showNextEle() {
        if (revealIndex >= revealOrder.length - 1) {
            console.log(` reveal next - end of pipeline`)
            return;
        }
        revealIndex += 1;
        const id = revealOrder[revealIndex];
        const node = cy.getElementById(id);
        console.log(` reveal next - ${revealIndex} - ${id}`)
        if (node && node.length > 0) {
            node.removeClass('hidden');
            showEdgesOfNode(node);
        }
    }

    function resetAnim() {
        revealIndex = -1;
        hideAll();
    }


    cy.once('layoutstop', () => {
        // revealNext();
    });


    window.addEventListener('keydown', (e) => {
        if (e.key === ' ' || e.key === 'ArrowRight') {
            e.preventDefault();
            // console.log(` space or right arrow`);
            showNextEle();
        }
        if (e.key === 'r' || e.key === 'R') {
            // console.log(` r  or R`);
            resetAnim();
        }
    });








    // const jsn1 = cy.elements().jsons()
    // console.log( jsn1 );

    // save text to a user-chosen file
    async function saveTextFile() {
        const handle = await window.showSaveFilePicker({
            suggestedName: 'nodes.json',
            types: [
                {
                    description: 'JSON Files',
                    accept: { 'application/json': ['.json'] }
                },
                {
                    description: 'Text',
                    accept: { 'text/plain': ['.txt'] }
                },
            ],

        });
        const writable = await handle.createWritable();
        const jsn2 = cy.elements().jsons();
        const jsonText = JSON.stringify(jsn2, null, 2);
        await writable.write(jsonText);
        await writable.close();
    }

    const btn = document.getElementById('saveJsonBtn');
    btn.addEventListener('click', async () => {
        console.log("clicked")
        saveTextFile()
    })





















</script>