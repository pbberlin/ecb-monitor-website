<style>
  html,
  body,
  dummy {
    height: 100%;
  }


  /*
    container: left-to-right flow, top-aligned
    3 columns
    - col 1: 20% - at least 20vm
    - col 2: exactly 820px
    - col 3: takes remaining width
  */
  .layout {
    display: grid;
    grid-template-columns: max(20rem, 20vw) 820px 1fr;
    column-gap: 0;
    align-items: start;           /* vertical: top for all */
  }

  /* Ensure grid items can shrink if needed */
  .col {
    min-width: 0;
    padding:   0;
    margin:    0;
    /* margin: 2px; */
    /* border: 1px solid red; */
  }

  /* per-cell horizontal alignment */
  /* first div: at least 20rem - 20% of screen width - */
  .col--left   { justify-self: end;    align-self: start; }
  /* second div: fixed 820px, content centered */
  .col--center { justify-self: center; align-self: start; }
  /* third div: takes the residual space, content left */
  .col--right  { justify-self: start;  align-self: start; }



  #echart_container {
    /* not 75% -  percent fails */
    height: 75vh;  

    /* margin:  0 auto; */
    padding: 0;
    /* border-top: 1px solid lightgray; */
    border-right: 1px solid lightgray;
    border-bottom: 1px solid lightgray;
    /* border: 1px solid lightgray; */
    box-sizing: border-box;    
  }





  .left-col-controls {
    position: relative;   /*  z-index  */
    z-index: 10;
    width: calc(  max(19.5rem, 20%)  );
    /* margin: 0 auto; */
    margin: 0.4rem;
    border-radius: 0.2rem;
    padding: 0.5rem 1.1rem;
    float: left;

    background-color: rgba(217,233,236,0.25)
  }

  #slider-group {
    margin-top: 1.2rem;
    display: flex;
    flex-direction: column;
    gap: 0.1rem;
    align-items: center;
    height: auto;

  }



  #bullet-container li { 
    list-style-type: circle;
    margin: 1rem;    
  }




</style>



<div class="layout">

  <div class="col col--left left-col-controls">
      <!-- First (top, right) -->
      <h3 > Fiskaldaten - √ñffentliche Schulden in % BIP: </h3>

      <!-- <label for="yearSlider">Year:</label> -->
      <div id="slider-group">
        <input id="yearSlider" type="range" min="2000" step="1"  autofocus />
        <span id="yearLabel"></span>
      </div>
  </div>


  <div class="col col--center">
    <!-- colbx1 -->

    <div id="echart_container">echart container content</div>

    <!-- colbx2 -->

    <ul id="bullet-container">

      <li>
        Ziemlich identische Daten - einmal 'UDGG' - einmal  'UDGGL' - L f√ºr "linked series".
        Ich begreife nicht, was der inhaltliche Unterschied ist.
      </li>

      <li>Auswahl Defizit , Staatsquote, ... -  sechs Radio-Buttons</li>
      <li>Play button </li>

      <li>Download - jede Variable separat - je nach Auswahl der Kennzahl  </li>

      <li>
        color code - 0 bis 60% - von gr√ºn zu gelb<br>
        60% bis 180% - von gelb zu rot<br>
        "Farbs√§ttigung" reduziert (Demo) <br>
        Idee: Unter 40% pure green?

          <div class="gradientWrapper">
              <div class="myGradient"></div>
              <div class="tick" style="left:   0px;">  0%</div>
              <div class="tick" style="left:  60px;"> 60%</div>
              <div class="tick" style="left: 100px;">100%</div>
              <div class="tick" style="left: 200px;">200%</div>
          </div>
      </li>
    </ul>
  </div>



  <div class="col col--right">
    <!-- right col -->
    <!-- Third col (top, left, fills the rest)  -->
  </div>


</div>






<!-- <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script> -->
<script type="text/javascript" src="/static/js/echarts.min.js"></script>
<script type="text/javascript" src="/static/js/eu-and-euro-countries.js"></script>


<!-- Uncomment this line if you want to dataTool extension -->
<!-- <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/echarts@6/dist/extension/dataTool.min.js"></script> -->

<!-- Uncomment this line if you want to use gl extension -->
<!-- <script type="text/javascript"  src="https://echarts.apache.org/en/js/vendors/echarts-gl/dist/echarts-gl.min.js"></script> -->

<!-- Uncomment this line if you want to echarts-stat extension -->
<!-- <script type="text/javascript" src="https://echarts.apache.org/en/js/vendors/echarts-stat/dist/ecStat.min.js"></script> -->

<!-- Uncomment this line if you want to echarts-graph-modularity extension -->
<!-- <script type="text/javascript" src="https://echarts.apache.org/en/js/vendors/echarts-graph-modularity/dist/echarts-graph-modularity.min.js"></script> -->


<!-- Uncomment this line if you want to use map -->
<!-- <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/echarts@4.9.0/map/js/world.js"></script> -->


<!-- Uncomment these two lines if you want to use bmap extension -->
<!-- <script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=YOUR_API_KEY"></script> -->
<!-- <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/echarts@6/dist/extension/bmap.min.js"></script> -->

<!-- <script type="text/javascript"> -->

<script src="/static/dl/ameco_debt_to_gdp.js"></script>
<script type="module">

  // wrap everything in an async func, since we need `await fetch(...)` at top level
  (async () => {

    const dom = document.getElementById('echart_container');

    const myChart = echarts.init(dom, null, {
      renderer: 'canvas',
      useDirtyRect: false
    });

    const root = document.documentElement;
    const colPri = getComputedStyle(root).getPropertyValue('--color-primary').trim();
    const colSec = getComputedStyle(root).getPropertyValue('--color-secondary').trim();
    const colGr2 = getComputedStyle(root).getPropertyValue('--color-grey-lt').trim();
    const colIB3 = getComputedStyle(root).getPropertyValue('--color-iceblue-3').trim();


    debtPercentOfGDP

    // creating the 'series' config for a pie chart with three random number.
    // Pie charts are easily positioned using either geo coordinates
    // or geojson 'name' -  via line  `center: centerLabelOrCoords`.
    // Other charts types dont have this feature - thus we have to
    //   pull the centroids for countries out of the geojson
    //     centroids['France']
    //     centroids['Spain']
    //     centroids[country][0], centroids[country][1]
    //      [2.21, 46.23]
    // The centroids have been finetuned in reshape-country.py
    function randomPieSeries1(centerLabelOrCoords, radius) {

      const data = ['A', 'B', 'C', 'D'].map((t) => {
        return {
          value: Math.round(Math.random() * 100),
          name: 'Category ' + t
        };
      });

      // map
      return {
        type: 'pie',
        coordinateSystem: 'geo',
        tooltip: {
          formatter: '{b}: {c} ({d}%)'
        },
        label: {
          show: false
        },
        labelLine: {
          show: false
        },
        animationDuration: 0,
        radius: radius,
        center: centerLabelOrCoords,
        data: data,
      };
    }


    // 0 to 60% - interpolate between green and green-red (yellow)
    // 60& to 180%  ... full red
    function pctToColor(pct) {

        if (pct <= 0) {
            return "#00ff00";          // green
        }
        if (pct >= 300) {
            pct = 300;
        }

        const green = [0x00, 0xff, 0x00];
        const olive = [0x80, 0x80, 0x00];
        const red   = [0xff, 0x00, 0x00];

        function interp(a, b, t) {
            const out = [0, 0, 0];
            for (let idx1 = 0; idx1 < 3; idx1++) {
                out[idx1] = Math.round(a[idx1] + (b[idx1] - a[idx1]) * t);
            }
            return out;
        }

        let rgb;

        if (pct <= 60) {
            const t = pct / 60;
            rgb = interp(green, olive, t);
        } else if (pct <= 180) {
            const t = (pct - 60) / 120;
            rgb = interp(olive, red, t);
        } else {
            rgb = red.slice();
        }

        const hex = rgb.map(function (v) {
            const h = v.toString(16);
            return h.length === 1 ? "0" + h : h;
        });

        // various degrees of color shock intensity
        return "#" + hex.join("") + "77";
        return "#" + hex.join("") + "99";
        return "#" + hex.join("") + "88";
    }



    function regionsColoring(yr=2025) {
      let results = [];

      for (const [idx, country] of nonMembers.entries()) {
          let item = { name: country, itemStyle: { areaColor: '#eee', borderWidth: 0.4, borderColor: '#ccc' } };
          // console.log(`  regionsColoring()-1 ${country}`);
          results.push(item);
      };

      /*
        rgb(194, 225, 226)
        rgb(214, 235, 236)
        rgb(235, 245, 246)
        rgb(255, 255, 255)
      */
      for (const [idx, country] of notInEuro.entries()) {
          // let item = { name: country, itemStyle: { areaColor: 'rgb(194, 225, 227)', borderColor: '#ccc' } };
          let item = { name: country, itemStyle: { areaColor: 'rgb(238, 245, 245)', borderWidth: 0.2,   aaborderColor: '#ccc' } };
          // console.log(`  regionsColoring()-2 ${country}`);
          results.push(item);
      };



      for (const [idx, country] of euCountriesEuro.entries()) {
          try {
             const statsValue    = debtPercentOfGDP[yr][country];
             const statsColoring = pctToColor(statsValue);
            // let item = { name: country, itemStyle: { areaColor: 'rgb(194, 225, 227)', borderColor: '#ccc' } };
            let item = { name: country, itemStyle: { areaColor: statsColoring,} };
            // x14x14
            results.push(item);
            // console.log(`  regionsColoring()-3 ${country} - ${statsValue}`);
          } catch (error) {
            console.log(`no stats value for ${country} for ${yr}`)
          }
      };

      // for (const [idx, country] of notInEuro.entries()) {
      return results;
    }


    function extraRectangle(country, offsetX, offsetY){
      // the rectangles around Cyprus and Malta, not Luxembourg,
      // differing only in offset
      const item =
        {
          name: `${country} Inset Rectangle`,
          itemStyle: {
            areaColor:   'none',
            areaColor:   'rgba(217,233,236,0.15)',
            borderColor: '#aaa',
            borderWidth: 0.5,   // <‚Äî thinner border (default is 1)
          },
          emphasis: { disabled: true },
          tooltip:  { show:     false },
          label: {
            show:      true,
            // magnifier optional
            // formatter: text + 'üîç',
            // formatter: 'üí†' + text.replace(/\s*\(Inset\)\s*$/i, '')  ,
            formatter: country,
            fontSize:       11,
            fontWeight:    300,

            // position: 'top-right',  // unsupported
            position: 'top',
            align:    'left',
            offset:    [offsetX, offsetY],
          },
        }
        return item;
    }



    // creating debt numbers at the centroid of 27 eu countries
    function manyCountriesShowStats(yr=2025) {
      let results = [];
      for (let country in debtPercentOfGDP[yr]) {
        const statsValue = debtPercentOfGDP[yr][country];
        // console.log(country, numberValue);
        let item = {
          type: 'scatter',
          coordinateSystem: 'geo',
          symbol: 'circle',
          // x14x14
          symbolSize: 34,
          symbolSize:  0,
          // symbolOffset: [10, -15],   // moves symbol and label
          color: pctToColor(statsValue),
          animationDuration: 0,
          label: {
            show: true,
            formatter:  Math.round(statsValue).toString() + ' %',
            fontSize:    14,
            fontSize:    12,
            fontWeight: 300,
            color: '#000',
            align: 'center',
            verticalAlign: 'middle',
            // offset:    [32, 0],
            // offset:    [0, 12],
          },
          data: [{ name: 'value', value: [   centroids[country][0], centroids[country][1], statsValue] }],
          tooltip:  { show: true, formatter: `${statsValue}` },
          tooltip:  { show: false },
          z: 10,
        };
        results.push(item);
      }
      return results;
    }






    //  determine the root path based on current host
    const ROOT_PATH = window.location.origin;
    let url;
    url = ROOT_PATH + '/static/echart/usa.json';
    url = ROOT_PATH + '/static/echart/europe-complete.geojson';
    url = ROOT_PATH + '/static/echart/europe-reduced-orig.geojson';
    url = ROOT_PATH + '/static/echart/europe-reduced.geojson';

    myChart.showLoading();

    let res;
    const isDevMode = window.APP_DEBUG;
    if (isDevMode) {
      // res = await fetch(url, { cache: 'no-cache' });
      res = await fetch(url, { cache: 'no-store' });
      console.log(`fetching map data - since development mode`);
    } else {
      res = await fetch(url, { cache: 'force-cache' });
      console.log(`map data from cache - since production mode`);
    }
    if (!res.ok) { throw new Error(`HTTP ${res.status}`); }
    const geoJSON = await res.json();   // works even if server sends text/plain
    echarts.registerMap('europe-reduced', geoJSON);
    console.log("europe geo json loaded and registered")

    // prepare longitude/latitude data from geojson file for positioning of geo shapes
    let centroids = {};
    for (let feature of geoJSON.features.entries()) {
      // console.log(feature[1].properties);
      let name = feature[1].properties.name;
      let lon = feature[1].properties.LON;
      let lat = feature[1].properties.LAT;
      centroids[name] = [lon, lat];
    }
    // console.log(centroids);
    // we can now use `centroids` for scatter data, tooltips, etc.



    console.log(` geo coords for centroid of France ${centroids["France"][0]} ${centroids["France"][1]}`)



    const option2 = {

      tooltip: {},
      legend: {
        show: false,
      },

      // global colors for series - taken from main-fonts.css
      color: [
        'rgb(194, 211,   0)',
        'rgb( 0,  105, 180)',
        'rgb(245, 245, 246)',
        'rgb(112, 111, 111)',
        'rgb(157, 157, 156)',
        'rgb(174, 215, 217)',
      ],


      geo: {
        map: 'europe-reduced',
        roam: true,
        aspectScale: Math.cos((55 * Math.PI) / 180),
        aspectScale: Math.cos((35 * Math.PI) / 180),
        aspectScale: Math.cos((30 * Math.PI) / 180),  // vertical compression of map projection

        // projection: {
        //     project: function (point) {
        //         return [point[0], Math.log(Math.tan((Math.PI / 4) + (point[1] * Math.PI / 360)))];
        //     },
        //     unproject: function (point) {
        //         return [point[0], (2 * Math.atan(Math.exp(point[1])) - Math.PI / 2) * 180 / Math.PI];
        //     }
        // },

        // zoom: 0.75,

        // top:    -240,     // margin top
        // bottom: -130,
        // left:   0,
        // right:  0,

        center:       [ 16     ,  48.8  ],  // geo center - longitute - latitude
        center:       [ 14     ,  48.8  ],
        center:       [ 12.05  ,  48.8  ],
        layoutCenter: ['50%', '50%'],    // where to place the geo center
        // layoutSize:    '250%',


        boundingCoords: [
            // [minLon, minLat],
            //  north of finland -  west of ireland
                [16 - 9.2         , 48.5 - 11.6],
            // [maxLon, maxLat],
                [16 + 9.2 - 0.2   , 48.5 + 11.6],
        ],

        nameProperty: 'name', //  name_en - for using en name.
        itemStyle: {
          // https://echarts.apache.org/en/option.html#legend.itemStyle
          areaColor: colIB3,
          borderColor:         '#999999',
          inactiveColor:       '#f11',
          inactiveBorderColor: '#ccc',
          borderWidth:           0.50,
        },

        // extra colors for eu non-members
        regions: [
          ...regionsColoring(),
          extraRectangle('Cyprus', -14,-34),
          extraRectangle('Malta' ,  -6,-24),
          // rectangles('Luxembourg' ,  0,0),
        ],


        // color when hovered
        emphasis: {
          itemStyle: {
            // color on hover
            areaColor: colPri
          },
          label: { show: false }
        },

      },   // end geo



      series: [
        // greenwich  longitude, latitude
        // randomPieSeries1([-1.6, 52.5], 25),

        // randomPieSeries1('France',  25),
        // randomPieSeries1('Germany', 35),
        ...manyCountriesShowStats(),
      ]

    };

    myChart.hideLoading();
    myChart.setOption(option2);
    console.log("echart options set 1")


    // if (option && typeof option === 'object') {
    //   console.log("echart options set 2")
    // }

    window.addEventListener('resize', myChart.resize);




    // --- slider setup: 1960 .. (current year + 1) ---
    const nextYear = new Date().getFullYear() + 1;
    const sliderEl = document.getElementById('yearSlider');
    const labelEl  = document.getElementById('yearLabel');

    sliderEl.max        = String(nextYear);
    sliderEl.value      = String(nextYear-1);
    labelEl.textContent = sliderEl.value;





    // --- onChange handler: update the chart option (stub) ---
    sliderEl.addEventListener('change', function () {

      const yr = parseInt(sliderEl.value, 10);
      labelEl.textContent = String(yr);

      // mutate option and re-apply
      let option3;

      // reset the stuff we want to update
      option3 = {
        series: [],
        geo: {
          regions: [],
        },
      };
      // re-populate
      option3.series = manyCountriesShowStats(yr);
      option3.geo.regions  = [
          ...regionsColoring(yr),
          extraRectangle('Cyprus', -14,-34),
          extraRectangle('Malta' ,  -6,-24),
      ];


      console.log(` changing year to ${yr} `);
      myChart.setOption(
          option3,
          {
            notMerge :   false,  // do merge
            lazyUpdate : true,
          },
        );
    });




  })();   // end of outmost aync func - so we can you fetch inside




</script>





<style>
.gradientWrapper {
    position: relative;
    height: 130px;
    width: 300px;
    margin: 20px;
}

.myGradient {
    height: 100px;
    width: 300px;
    background: linear-gradient(
        to right,
        green     0px,
        #808000  60px,
        #808000  60px,
        red     180px,
        red     300px
    );
    border: 1px solid #444;
}

.tick {
    position: absolute;
    bottom: 0;
    height: 5px;
    width:   1px;
    background: black;
    text-align: center;
    transform: translateX(-50%);
    font-size: 12px;
    color: black;
}

.tick::after {
    /* content: attr(style); */
}

.tick {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.tick::before {
    content: "";
    height: 4px;
    width:  1px;
    background: black;
}

.tick {
    top: 100px;
}

.tick span {
    margin-top: 5px;
}
</style>




