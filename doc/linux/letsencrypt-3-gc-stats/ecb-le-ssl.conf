<IfModule mod_ssl.c>
<VirtualHost *:443>

    # sudo vim  /etc/apache2/sites-available/ecb-le-ssl.conf

    ServerName           ecb-monitor.zew.de
    ServerAlias          ezb-monitor.zew.de
    ServerAlias          ezb-transparenz-monitor.zew.de
    ServerAlias          ecb-transparency-monitor.zew.de
    ServerAlias          ecb-watch.zew.de
    ServerAlias          ezb-watch.zew.de
    ServerAlias          ecbwatch.zew.de
    ServerAlias          ezbwatch.zew.de
    #ServerName example.com


    ServerAdmin webmaster@localhost


    # Single daemon definition lives ONLY here:
    WSGIDaemonProcess ecb user=www-data group=www-data \
        python-home=/var/www/ecb-app/.venv \
        python-path=/var/www/ecb-app
    WSGIProcessGroup ecb
    WSGIScriptAlias / /var/www/ecb-app/ecb.wsgi process-group=ecb application-group=%{GLOBAL}

    <Directory /var/www/ecb-app>
        Require all granted
    </Directory>

    # Static files (fix path to match the Alias target)
    Alias /static/ /var/www/ecb-app/static/
    <Directory /var/www/ecb-app/static>
        Require all granted
    </Directory>

    SSLEngine on
    Include /etc/letsencrypt/options-ssl-apache.conf

    ErrorLog  ${APACHE_LOG_DIR}/ecb_error_ssl.log
    CustomLog ${APACHE_LOG_DIR}/ecb_access_ssl.log combined
    SSLCertificateFile    /etc/letsencrypt/live/ecb-monitor.zew.de/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/ecb-monitor.zew.de/privkey.pem



    # GoatCounter counting endpoint under /gc (same origin, HTTPS)
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"

    # GoatCounter counting endpoint under /gc-stats (same origin, HTTPS)
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"

    # Map https://ecb-monitor.zew.de/gc-stats -> http://127.0.0.1:8811/count
    ProxyPass        "/gc-stats" "http://127.0.0.1:8811/count"
    ProxyPassReverse "/gc-stats" "http://127.0.0.1:8811/count"




    # ---- GoatCounter ADMIN under /gc-admin (best-effort; relies on rewriting) ----
    # Upstream GC is plain HTTP on the same box (adjust host:port if needed)
    # IMPORTANT: disable upstream compression so Apache can rewrite HTML
    RequestHeader unset Accept-Encoding

    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"

    # 1) Strip /gc-admin prefix before proxying to GC
    RewriteEngine On
    RewriteRule ^/gc-admin/?(.*)$ http://127.0.0.1:8811/$1 [P,QSA,L]

    # 2) Fix redirects and cookie paths coming back
    ProxyPassReverse        /gc-admin http://127.0.0.1:8811/
    ProxyPassReverse        /        http://127.0.0.1:8811/
    ProxyPassReverseCookiePath / /gc-admin/

    # 3) Rewrite absolute URLs in HTML (links, forms, assets) to include /gc-admin
    <Location /gc-admin/>
        SetOutputFilter proxy-html
        ProxyHTMLEnable On
        ProxyHTMLInterp On

        # Map absolute-root URLs from upstream to the subdir
        # This covers href="/...", src="/...", action="/...", etc.
        ProxyHTMLURLMap  /  /gc-admin/

        # (Optional) lock down access; otherwise omit this block or use Require all granted
        # Require ip 192.168.0.0/16
    </Location>


</VirtualHost>
</IfModule>

